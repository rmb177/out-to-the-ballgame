// Generated by CoffeeScript 1.3.1
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty;

  ottb.Map = (function() {

    Map.name = 'Map';

    function Map(selectLinkCallback) {
      this.animateMarkers = __bind(this.animateMarkers, this);
      this.map = new google.maps.Map(document.getElementById("schedule-map"), gMapOptions);
      this.gameMarkers = {};
      this.displayedGames = {};
      this.lastInfoWindow = null;
      this.selectLinkCallback = selectLinkCallback;
      this.setupSelectLinkListener();
      this.animateMarkers();
    }

    Map.prototype.addDatePicker = function(datePickerHtml) {
      return this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(datePickerHtml);
    };

    Map.prototype.addItinerary = function(itineraryHtml) {
      return this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(itineraryHtml);
    };

    Map.prototype.displayGames = function(newGames) {
      var displayedGame, hasIt, newGame, teamAbbr, that, _i, _len, _ref, _results,
        _this = this;
      that = this;
      if (this.lastInfoWindow !== null) {
        this.lastInfoWindow.close();
      }
      _ref = this.displayedGames;
      for (teamAbbr in _ref) {
        if (!__hasProp.call(_ref, teamAbbr)) continue;
        displayedGame = _ref[teamAbbr];
        hasIt = newGames.some(function(newGame) {
          return newGame.home_team_abbr === displayedGame.home_team_abbr;
        });
        if (!hasIt) {
          this.fadeOutMarker(this.gameMarkers[displayedGame.home_team_abbr]);
          delete this.displayedGames[displayedGame.home_team_abbr];
        }
      }
      _results = [];
      for (_i = 0, _len = newGames.length; _i < _len; _i++) {
        newGame = newGames[_i];
        _results.push((function(newGame) {
          var context, marker, source, template;
          marker = _this.gameMarkers[newGame.home_team_abbr];
          if (!(marker != null)) {
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(parseFloat(newGame.lat), parseFloat(newGame.lon)),
              map: _this.map,
              opacity: 0,
              opacities: []
            });
          }
          marker.setTitle(newGame.away_team_name + ' @ ' + newGame.home_team_name);
          hasIt = _this.displayedGames[newGame.home_team_abbr] != null;
          if (!hasIt) {
            _this.fadeInMarker(marker, 0);
          }
          source = $("#info-window").html();
          template = Handlebars.compile(source);
          context = {
            game_id: newGame.id,
            away_team: newGame.away_team_abbr,
            home_team: newGame.home_team_abbr,
            game_time: newGame.game_time,
            displaySelectGameLink: true
          };
          google.maps.event.addListener(marker, 'click', function() {
            if (_this.lastInfoWindow !== null) {
              _this.lastInfoWindow.close();
            }
            _this.lastInfoWindow = new google.maps.InfoWindow();
            _this.lastInfoWindow.setContent(template(context));
            _this.lastInfoWindow.open(that.map, marker);
            return false;
          });
          _this.gameMarkers[newGame.home_team_abbr] = marker;
          return _this.displayedGames[newGame.home_team_abbr] = newGame;
        })(newGame));
      }
      return _results;
    };

    Map.prototype.setupSelectLinkListener = function() {
      var that;
      that = this;
      return $(document).on("click", ".select-game-link a", function(event) {
        if (that.lastInfoWindow !== null) {
          that.lastInfoWindow.close();
        }
        that.selectLinkCallback(this.id);
        return false;
      });
    };

    Map.prototype.fadeInMarker = function(marker) {
      return marker.opacities = marker.opacities.concat([.2, .4, .6, .8, 1]);
    };

    Map.prototype.fadeOutMarker = function(marker) {
      if (marker.opacity > 0) {
        return marker.opacities = marker.opacities.concat([.8, .6, .4, .2, 0]);
      }
    };

    Map.prototype.animateMarkers = function() {
      var aMarker, teamAbbr, _ref,
        _this = this;
      _ref = this.gameMarkers;
      for (teamAbbr in _ref) {
        if (!__hasProp.call(_ref, teamAbbr)) continue;
        aMarker = _ref[teamAbbr];
        if (aMarker.opacities.length > 0) {
          aMarker.setOpacity(aMarker.opacities[0]);
          aMarker.opacities.shift();
        }
      }
      return setTimeout(function() {
        return _this.animateMarkers();
      }, 50);
    };

    return Map;

  })();

}).call(this);
